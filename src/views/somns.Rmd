---
title: "SOMns Performance Comparison"
output: html_fragment
# http://localhost:33333/compare/SOMns/0d020c65f5ff950d5a9f3a6a87c08585f136afc8/b93035d99ba0f066240c3515745111be7d151e00
params:
  baseline: "b0bd089afdb2f3437c52486630ceb82e96a741d9"
  change: "b3d66873c97cac6d4e2f79e8b6a91e3397161b62"
  baseline_color: "#729fcf"
  change_color: "#e9b96e"
  fast_color: "#e4ffc7"
  slow_color: "#ffcccc"
  faster_runtime_ratio: 0.95
  slower_runtime_ratio: 1.05
  db_user: null  # rdb_sm1
  db_pass: null
  db_name: rdb_sm1
  lib_dir: "."
  extraCmd: "" # any other command as ; separated list
---

```{r setup, include=FALSE, echo=FALSE, warning=FALSE}
source(paste0(params$lib_dir, "/common.R"), chdir=TRUE)
enable_chunk_timing()
options(warn=1)
```

```{r load-db, include=FALSE, echo=FALSE, warning=FALSE, timeit=TRUE}
# from-file: baseline_hash <- "7f7bf31c928147db34ea619ba0a897237cca8297"
# from-file: change_hash <- "08a38cd7501acca82312722889b830b4f3a4865f"
baseline_hash <- params$baseline
change_hash <- params$change
baseline_hash6 <- substr(baseline_hash, 1, 6)
change_hash6 <- substr(change_hash, 1, 6)

baseline_color <- params$baseline_color
change_color <- params$change_color

color <- setNames(c(baseline_color, change_color), c(baseline_hash6, change_hash6))

library(dplyr)
library(stringr)

cmds <- str_split(params$extraCmd, ";")[[1]]

if (cmds[1] == "from-file") {
  # manual from-file: result <- rbind(load_data_file("~/Projects/tmp/SOMns-136.qs"), load_data_file("~/Projects/tmp/SOMns-141.qs"))
  result <- rbind(load_data_file(cmds[2]), load_data_file(cmds[3]))
  result <- factorize_result(result)
} else {
  # load_and_install_if_necessary("psych")   # uses only geometric.mean
  rebenchdb <- connect_to_rebenchdb(params$db_name, params$db_user, params$db_pass)
  result <- get_measures_for_comparison(rebenchdb, baseline_hash, change_hash)
  disconnect_rebenchdb(rebenchdb)
}
```


```{r comp, timeit=TRUE}
warmup <- result %>%
  filter(!grepl("startup", suite, fixed = TRUE),
         !grepl("interp", exe, fixed = TRUE)) %>%
  droplevels()

peak <- result %>%
  group_by(commitid, exe, suite, bench,
           varvalue, cores, inputsize, extraargs) %>%
  filter(is.na(warmup) | iteration >= warmup)


base <- peak %>%
  filter(commitid == baseline_hash6) %>%
  group_by(exe, suite, bench,
           varvalue, cores, inputsize, extraargs) %>%
  summarise(base_mean = mean(value),
            base_median = median(value),
            .groups = "drop")

norm <- peak %>%
  left_join(base, by = c("exe", "suite", "bench",
                         "varvalue", "cores", "inputsize", "extraargs")) %>%
  group_by(exe, suite, bench,
           varvalue, cores, inputsize, extraargs) %>%
  transform(ratio_mean = value / base_mean,
            ratio_median = value / base_median)

stats <- norm %>%
  group_by(commitid, exe, suite, bench,
           varvalue, cores, inputsize, extraargs) %>%
  filter(is.na(warmup) | iteration >= warmup) %>%
  summarise(
    unit = unit[1],
    min = min(value),
    max = max(value),
    sd = sd(value),
    mean = mean(value),
    median = median(value),
    samples = length(value),

    # mean_ratio_mean = mean(ratio_mean),
    # median_ratio_median = median(ratio_mean),
    # mean_ratio_median = mean(ratio_median),
    lowerBCI95 = get_bca(value, 1000)$lower,
    upperBCI95 = get_bca(value, 1000)$upper,

    ratio = median / base_median[1],
    ratioLower = lowerBCI95 / base_median[1],
    ratioUpper = upperBCI95 / base_median[1],

    change_m = ratio - 1,
    change_l = ratioLower - 1,
    change_u = ratioUpper - 1,
    .groups = "drop")

not_in_both <- stats %>%
  filter(is.na(ratio)) %>%
  droplevels()

stats <- stats %>%
  filter(!is.na(ratio)) %>%
  droplevels()

geometric.mean <- function(x) { exp(mean(log(x))) }

## Are we faster/slower? have a rough 5% boundary for all the noise
slower_category <- function(data) {
  m <- geometric.mean(data)
  if (m > 1.05) {
    return("slower")
  } else if (m < 0.95) {
    return("faster")
  } else {
    return("indeterminate")
  }
}
```

```{r check-for-data, timeit=TRUE, results='asis'}
if (nrow(stats %>% filter(commitid == change_hash6)) == 0) {
  cat("<h3>Issue with Unexpected Data</h3>")
  cat("<p>The data provided for baseline and change does not seem to have a common benchmarks/executors.</p>\n")
  cat("<p>This is known to happen for instance, when benchmarks or parameters are changed, or executors renamed.</p>\n")
  knitr::knit_exit()
}
```

```{r comp-2, timeit=TRUE}
stats_suite <- stats %>%
  filter(commitid == change_hash6) %>% # need to remove it so that statistics are accurate, or put it into the group
  filter(!is.na(ratio)) %>%            # filter out the benchmarks not in both data sets
  group_by(exe, suite) %>%
  summarise(
    unit = unit[1],
    min = min(ratio),
    max = max(ratio),
    geomean = geometric.mean(ratio),
    num_benchmarks = length(ratio),
    slower = slower_category(ratio),
    .groups = "drop")

stats_suite$slower <- factor(stats_suite$slower)

stats_all <- stats_suite %>%
  summarise(
    unit = unit[1],
    min = min(geomean),
    max = max(geomean),
    geomean = geometric.mean(geomean),
    num_benchmarks = sum(num_benchmarks),
    .groups = "drop")
```

## Summary Over All Benchmarks

```{r summary-suites, fig.height=2.5, fig.width=4.5, timeit=TRUE}
data_chg <- stats %>%
  filter(commitid == change_hash6) %>%
  select(commitid, exe, suite, bench, ratio,
         varvalue, cores, inputsize, extraargs) %>%
  droplevels()

data_chg_slow <- data_chg %>%
  left_join(stats_suite, by = c("exe", "suite")) %>%
  filter(commitid == change_hash6) %>%
  droplevels()

compare_runtime_ratio_of_suites_plot(
  data_chg_slow,
  params$slower_runtime_ratio, params$faster_runtime_ratio,
  params$fast_color, params$slow_color, color)
```

<dl class="row">
  <dt class="col-sm-3">Number of Benchmarks</dt>
  <dd class="col-sm-8">`r stats_all$num_benchmarks`</dd>

  <dt class="col-sm-3">Geometric Mean</dt>
  <dd class="col-sm-8">`r round(stats_all$geomean, 3)` (min. `r r2(stats_all$min)`, max. `r r2(stats_all$max)`)</dd>
</dl>

```{r data-set-changes, results='asis'}
if (nrow(not_in_both) > 0) {
  library(knitr)
  cp("<h3>Changes in Benchmark Set</h3>")

  kable(not_in_both %>% select(commitid, exe, suite, bench,
                               varvalue, cores, inputsize, extraargs), format = "html")
}
```

## Benchmark Performance

<dl class="row">
  <dt class="col-sm-2">Baseline</dt>
  <dd class="col-sm-9"><span class="baseline-badge">`r baseline_hash6`</span></dd>

  <dt class="col-sm-2">Change</dt>
  <dd class="col-sm-9"><span class="change-badge">`r change_hash6`</span></dd>

<dt class="col-sm-2">Significant Change</dt>
<dd class="col-sm-9"><div class="form-row">
<input type="range" class="col-6 custom-range" min="0" max="15" step="0.5" id="significance" style="padding-top: 1.75ex; padding-right: 1em;" value="5">
<input type="text" readonly class="col-4 form-control-plaintext" id="significance-val" value="5%">
</div></dd>
</dl>

```{r suites, results='asis', echo=FALSE, dev='svg', fig.keep='all', fig.height=0.3, fig.width=3, timeit=TRUE}
perf_diff_table <- function(norm, stats) {

for (e in levels(norm$exe)) {         data_e <- norm   %>% filter(exe == e)   %>% droplevels()
  for (s in levels(data_e$suite)) {   data_s <- data_e %>% filter(suite == s) %>% droplevels()
    cp("<h3>", s, "</h3>")
    cp('<div class="title-executor">Executor: ', e, "</div>")

    cp('<table class="table table-sm benchmark-details">')
    cp('<thead><tr>
<th scope="col"></th>
<th scope="col"></th>
<th scope="col" title="Number of Samples">#M</th>
<th scope="col">mean in ', levels(data_s$unit), '</th>
<th scope="col">median in ', levels(data_s$unit), '</th>
<th scope="col">change in %</th>
<th scope="col"></th>
</tr></thead>')


    for (b in levels(data_s$bench)) { data_b <- data_s %>% filter(bench == b) %>% droplevels()
      for (v in levels(data_b$varvalue)) {   data_v  <- data_b %>% filter(varvalue == v)   %>% droplevels()
      for (c in levels(data_v$cores)) {      data_c  <- data_v %>% filter(cores == c)      %>% droplevels()
      for (i in levels(data_c$inputsize)) {  data_i  <- data_c %>% filter(inputsize == i)  %>% droplevels()
      for (ea in levels(data_i$extraargs)) { data_ea <- data_i %>% filter(extraargs == ea) %>% droplevels()

        args <- ""
        if (length(levels(data_b$varvalue))  > 1) { args <- paste0(args, v) }
        if (length(levels(data_v$cores))     > 1) { args <- paste0(args, c) }
        if (length(levels(data_c$inputsize)) > 1) { args <- paste0(args, i) }
        if (length(levels(data_i$extraargs)) > 1) { args <- paste0(args, ea) }
        if (nchar(args) > 0) {
          args <- paste0('<span class="all-args">', args, '</span>')
        }

        # capture the beginning of the path but leave the last element of it
        # this regex is also used in render.js's renderBenchmark() function
        cmdline <- str_replace_all(data_i$cmdline[[1]], "^(.*?)((?:\\/\\w+)\\s.*$)", ".\\2")
        
        stats_b <- stats %>%
          ungroup() %>%
          filter(bench == b, suite == s, exe == e, varvalue == v, cores == c, inputsize == i, extraargs == ea, commitid == change_hash6) %>%
          droplevels()

        if (nrow(stats_b) > 0) {
          cp('<tr>')
          cp('<th scope="row">',  b, args, '</th>')
          cp('<td>')
          p <- small_inline_comparison(data_b)
          print(p)
          cp('</td>')

          cp('<td class="stats-samples">', stats_b$samples, '</td>')
          cp('<td><span class="stats-mean" title="mean">', r2(stats_b$mean), '</span><span class="stats-sd" title="standard deviation">', r2(stats_b$sd), '</span></td>')
          cp('<td><span class="stats-median" title="median">', r2(stats_b$median), '</span><span class="stats-min" title="minimum">', r2(stats_b$min), '</span><span class="stats-max" title="maximum">', r2(stats_b$max),'</span></td>')
          cp('<td><span class="stats-change" title="change over median">', pro(stats_b$change_m), '</span><span class="stats-change-l" title="lower bound of 95% bootstrap confidence interval">', pro(stats_b$change_l), '</span><span class="stats-change-u" title="upper bound of 95% bootstrap confidence interval">', pro(stats_b$change_u), '</span></td>')
          cp('<td><button type="button" class="btn btn-sm" data-toggle="popover" data-html="true" data-content="<code>', cmdline, '</code>">',
             '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-terminal" viewBox="0 0 16 16">
  <path d="M6 9a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3A.5.5 0 0 1 6 9zM3.854 4.146a.5.5 0 1 0-.708.708L4.793 6.5 3.146 8.146a.5.5 0 1 0 .708.708l2-2a.5.5 0 0 0 0-.708l-2-2z"/>
  <path d="M2 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2H2zm12 1a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h12z"/>
</svg>',
             '</button></td>')

          cp('</tr>')
        } else {
          cp('<tr>')
          cp('<th scope="row">',  b, '</th><td colspan="4">missing in one of the data sets</td>')
          cp('</tr>')
        }
      } } } }
    }

    cp('</table>')
  }
}
}

perf_diff_table(norm, stats)
```

```{r prep-comparison-data, results='asis', echo=FALSE, dev='svg', fig.keep='all', fig.height=0.3, fig.width=3, timeit=TRUE}
execs <- levels(peak$exe)
exec_name <- str_replace_all(execs, c("-jit" = "", "-interp" = ""))
exec_name <- union(exec_name, exec_name)

exe_type <- function(data) {
  # print(data)
  ifelse(grepl("-jit", data), "jit", ifelse(grepl("-interp", data), "interp", "other"))
}

# The cross comparison is designed for setups where there are two clearly
# different sets of experiments. The current heuristic assumes that
# interpreter (-interp) and jit-compiling (-jit) VMs are among the executors,
# which without these name parts, form a set of two distinct names.
if (length(exec_name) == 2) {
  cat("<h2>Cross Comparison</h2>\n")
  
  base_exe <- exec_name[[1]]
  cp("<p>Baseline: ", base_exe, "</p>")
  
  peak_comp <- peak %>%
    transform(exe_type = exe_type(exe))
  peak_comp$exe_type <- factor(peak_comp$exe_type)
  
  base_comp <- peak_comp %>%
    filter(commitid == change_hash6, grepl(base_exe, exe)) %>%
    group_by(exe_type, suite, bench,
             varvalue, cores, inputsize, extraargs,
             commitid) %>%
    summarise(base_mean = mean(value),
              base_median = median(value),
              .groups = "drop")
  
  norm_comp <- peak_comp %>%
    filter(commitid == change_hash6) %>%
    left_join(base_comp,
              by = c("exe_type", "suite", "bench",
                     "varvalue", "cores", "inputsize", "extraargs",
                     "commitid")) %>%
    group_by(exe_type, suite, bench,
             varvalue, cores, inputsize, extraargs,
             commitid) %>%
    transform(ratio_mean = value / base_mean,
              ratio_median = value / base_median)

  stats_comp <- norm_comp %>%
    group_by(commitid, exe, suite, bench,
             varvalue, cores, inputsize, extraargs) %>%
    filter(is.na(warmup) | iteration >= warmup) %>%
    summarise(
      unit = unit[1],
      min = min(value),
      max = max(value),
      sd = sd(value),
      mean = mean(value),
      median = median(value),
      samples = length(value),
              
      # mean_ratio_mean = mean(ratio_mean),
      # median_ratio_median = median(ratio_mean),
      # mean_ratio_median = mean(ratio_median),
      lowerBCI95 = get_bca(value, 1000)$lower,
      upperBCI95 = get_bca(value, 1000)$upper,
              
      ratio = median / base_median[1],
      ratioLower = lowerBCI95 / base_median[1],
      ratioUpper = upperBCI95 / base_median[1],
              
      change_m = ratio - 1,
      change_l = ratioLower - 1,
      change_u = ratioUpper - 1,
      .groups = "drop") %>%
      ## Drop the things that don't have matching results
      filter(!is.na(ratio)) %>%
      droplevels()
  
  perf_diff_table(norm_comp %>% filter(!grepl(base_exe, exe)), stats_comp)
}
```



## Warmup Behavior

This section excludes all interpreter-only and startup benchmarks.
```{r warmup-plots, echo=FALSE, results='asis', dev='svg', fig.keep='all', fig.width=6, fig.height=2.5, timeit=TRUE}
# b <- "Mandelbrot"

for (e in levels(warmup$exe)) {
  data_e <- warmup %>% filter(exe == e) %>% droplevels()

  for (s in levels(data_e$suite)) {
    data_s <- data_e %>% filter(suite == s) %>% droplevels()

    for (b in levels(data_s$bench)) {
      data_b <- data_s %>% filter(bench == b) %>% droplevels()

      for (v in levels(data_b$varvalue)) {         data_v  <- data_b %>% filter(varvalue == v)   %>% droplevels()
        for (c in levels(data_v$cores)) {          data_c  <- data_v %>% filter(cores == c)      %>% droplevels()
          for (i in levels(data_c$inputsize)) {    data_i  <- data_c %>% filter(inputsize == i)  %>% droplevels()
            for (ea in levels(data_i$extraargs)) { data_ea <- data_i %>% filter(extraargs == ea) %>% droplevels()
              cp('<div><span class="warmup-benchmark">', b, '</span><span class="warmup-suite">', s, '</span><span class="warmup-exe">', e, '</span>')
              args <- ""
              if (length(levels(data_b$varvalue))  > 1) { args <- paste0(args, v) }
              if (length(levels(data_v$cores))     > 1) { args <- paste0(args, c) }
              if (length(levels(data_c$inputsize)) > 1) { args <- paste0(args, i) }
              if (length(levels(data_i$extraargs)) > 1) { args <- paste0(args, ea) }
              if (nchar(args) > 0) {
                cp('<span class="all-args">', args, '</span>')
              }

              cp('<div class="warmup-plot">')
              warmup_plot(data_ea, b, s, e)
              cp('</div></div>')
            }
          }
        }
      }
    }
  }
}
```

<script>
// initialize the popovers 
$(function () {
  $('[data-toggle="popover"]').popover()
})
</script>
